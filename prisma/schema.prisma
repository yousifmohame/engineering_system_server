// server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===============================================
// 1. نماذج المستخدمين والصلاحيات (Core Identity & Access)
// ===============================================

// ------ نموذج الموظفين (شاشة 817) ------
model Employee {
  id                String    @id @default(cuid())
  employeeCode      String    @unique @default(cuid())
  name              String
  nameEn            String?
  nationalId        String    @unique
  email             String    @unique
  phone             String    @unique
  position          String
  department        String
  hireDate          DateTime
  baseSalary        Float?
  jobLevel          Int?
  type              String    @default("full-time")
  status            String    @default("active")
  nationality       String?
  gosiNumber        String?
  iqamaNumber       String?
  performanceRating Float?
  frozenUntil       DateTime?
  frozenReason      String?
  password          String
  refreshToken      String?
  permissionsCount  Int?      // عدد الصلاحيات المخصصة
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // --- العلاقات الفرعية للموظف ---
  attachments       Attachment[]       @relation("EmployeeAttachments")
  attendanceRecords EmployeeAttendance[]
  leaveRequests     EmployeeLeaveRequest[]
  skills            EmployeeSkill[]
  certifications    EmployeeCertification[]
  evaluations       EmployeeEvaluation[]
  promotions        EmployeePromotion[]

  // --- علاقات العمل والمهام ---
  roles              JobRole[]           @relation("EmployeeToJobRole")
  specialPermissions Permission[]        @relation("EmployeeToSpecialPermission")
  managedProjects    Project[]
  assignedTasks      Task[]              @relation("EmployeeToTask")
  
  // --- المراسلات ---
  sentMessages        Message[]           @relation("SenderToMessage")
  conversations       Conversation[]      @relation("EmployeeToConversation")
  
  // --- النظام المالي والإداري ---
  uploadedAttachments    Attachment[]
  paymentsReceived       Payment[]               @relation("EmployeeToPayment")
  activitiesPerformed    ActivityLog[]           @relation("EmployeeToActivityLog")
  
  // --- إدارة الوثائق ---
  ownedDocuments         Document[]              @relation("OwnedDocuments")
  docPermissions         DocumentPermission[]    @relation("GrantedPermissions")
  documentActivities     DocumentActivity[]
  documentAccess         DocumentPermission[]    // الصلاحيات الممنوحة للموظف
  createdClassifications DocumentClassification[] @relation("CreatedClassifications")
  
  // --- المعاملات ---
  transactionAssignments TransactionEmployee[]
}

// نموذج لسجل الحضور
model EmployeeAttendance {
  id         String    @id @default(cuid())
  date       DateTime  @db.Date
  status     String    // (Present, Absent, On Leave)
  checkIn    DateTime? @db.Time
  checkOut   DateTime? @db.Time
  notes      String?

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String

  @@index([employeeId, date])
}

// نموذج لطلبات الإجازات
model EmployeeLeaveRequest {
  id         String   @id @default(cuid())
  type       String   // (سنوية, مرضية, ...)
  startDate  DateTime @db.Date
  endDate    DateTime @db.Date
  status     String   @default("Pending") // (Pending, Approved, Rejected)
  reason     String?

  employee   Employee @relation(fields: [employeeId], references: [id])
  employeeId String

  @@index([employeeId])
}

// نموذج لمهارات الموظف
model EmployeeSkill {
  id         String @id @default(cuid())
  category   String // (فنية, إدارية, لغات)
  skill      String // (AutoCAD, React, إدارة مشاريع)
  level      String // (مبتدئ, متوسط, خبير)

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId])
}

// نموذج لشهادات الموظف
model EmployeeCertification {
  id         String    @id @default(cuid())
  name       String    // (PMP, شهادة AWS)
  authority  String    // (PMI, Amazon)
  issueDate  DateTime  @db.Date
  expiryDate DateTime? @db.Date

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId])
}

// نموذج لتقييمات الموظف
model EmployeeEvaluation {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  evaluator String   // (اسم المُقيّم أو الإدارة)
  rating    Float    // (التقييم من 5)
  comments  String?

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId, date])
}

// نموذج لترقيات الموظف
model EmployeePromotion {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  oldPosition String
  newPosition String
  oldLevel    Int
  newLevel    Int
  notes       String?

  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId String

  @@index([employeeId, date])
}

// ------ نموذج الأدوار الوظيفية (شاشة 903) ------
model JobRole {
  id               String   @id @default(cuid())
  code             String   @unique
  nameAr           String
  nameEn           String?
  description      String?
  responsibilities String[] 
  level            String?
  department       String?
  status           String   @default("active")
  canAssignTasks   Boolean  @default(true)
  allowMultiple    Boolean  @default(true)
  allowMultiRole   Boolean  @default(true)
  order            Int?
  
  createdDate      DateTime @default(now())
  lastModified     DateTime @updatedAt
  modifiedBy       String?
  
  parentRole       JobRole?  @relation("RoleHierarchy", fields: [parentRoleId], references: [id])
  parentRoleId     String?
  childRoles       JobRole[] @relation("RoleHierarchy")

  employees        Employee[]   @relation("EmployeeToJobRole")
  permissions      Permission[] @relation("JobRoleToPermission")
}

// ------ نموذج الصلاحيات (شاشة 902) ------
model Permission {
  id             String    @id @default(cuid())
  code           String    @unique
  name           String
  description    String?
  level          String
  screenId       String?
  screenName     String?
  tabId          String?
  tabName        String?
  actionType     String?
  status         String    @default("active")
  
  frozenType     String?
  frozenDate     DateTime?
  frozenUntil    DateTime?
  frozenBy       String?
  frozenReason   String?
  
  createdDate    DateTime  @default(now())
  lastModified   DateTime  @updatedAt
  modifiedBy     String?
  
  roles          JobRole[]         @relation("JobRoleToPermission")
  employees      Employee[]        @relation("EmployeeToSpecialPermission")
  groups         PermissionGroup[] @relation("GroupToPermission")
}

// ------ نموذج مجموعات الصلاحيات ------
model PermissionGroup {
  id          String   @id @default(cuid())
  code        String   @unique
  name        String
  description String?

  permissions Permission[] @relation("GroupToPermission")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
}

// ===============================================
// 2. نموذج العملاء (Client Module) - محدث ليدعم WMS
// ===============================================

// ------ نموذج العميل (شاشة 300) ------
model Client {
  id             String  @id @default(cuid())
  clientCode     String  @unique 

  // --- بيانات الاتصال الأساسية ---
  mobile         String  @unique
  email          String? @unique
  idNumber       String  @unique // الهوية الوطنية

  // --- بيانات JSON للمرونة ---
  name             Json  // { ar: "...", en: "..." }
  contact          Json 
  address          Json? 
  identification   Json 

  // --- حقول WMS الصريحة (للسرعة والفلترة) ---
  officialNameAr   String? @map("official_name_ar") // مهم جداً للبحث
  riskTier         String  @default("LOW")          // LOW, MEDIUM, HIGH
  
  // --- التفاصيل ---
  type             String // (فرد، شركة، جهة حكومية)
  category         String? // (VIP, مؤسسة, عادي)
  nationality      String?
  occupation       String?
  company          String?
  taxNumber        String?
  rating           Int?    @default(3)
  secretRating     Int?    @default(50)
  grade            String? // (أ, ب, ج)
  gradeScore       Int?
  completionPercentage Float?
  isActive         Boolean @default(true)
  notes            String?
  createdBy        String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // --- العلاقات ---
  ownerships   OwnershipFile[] // علاقة جديدة (شاشة 310)
  transactions Transaction[]
  contracts    Contract[]
  quotations   Quotation[]
  attachments  Attachment[]
  activityLogs ActivityLog[]
  documents    Document[]
}

model ClientClassification {
  id          String  @id @default(cuid())
  name        String  @unique
  color       String
  description String?
  isActive    Boolean @default(true)
}


// ===============================================
// 3. نموذج الملكيات (Ownership / Deeds Module)
// ===============================================

model OwnershipFile {
  id                String             @id @default(cuid())
  code              String             @unique // كود مرجعي للنظام OWN-2026-xxx
  
  // --- تفاصيل الصك (Deed Details) ---
  deedNumber        String?            @unique // رقم الصك (مهم للبحث)
  deedDate          DateTime?          @db.Date
  issuingAuthority  String?            // الجهة المصدرة (كتابة العدل الأولى بالرياض مثلاً)
  status            String             @default("Active") // Active, Sold, Mortgage
  
  // --- البيانات المكانية (Spatial Data) ---
  city              String?
  district          String?
  planNumber        String?            // رقم المخطط
  blockNumber       String?            // رقم البلوك (تمت إضافته)
  plotNumber        String?            // رقم القطعة
  area              Float?             // المساحة بالمتر المربع
  
  // --- إحداثيات (لخرائط جوجل أو GIS) ---
  centerLat         Float?
  centerLng         Float?
  
  notes             String?

  documents   Json? @default("[]") // الوثائق
  plots       Json? @default("[]") // القطع
  owners      Json? @default("[]") // الملاك والحصص
  boundaries  Json? @default("[]") // الحدود والأطوال
  aiData      Json?                // بيانات الذكاء الاصطناعي المستخرجة
  attachments Json? @default("[]") // المرفقات
  
  // --- العلاقات ---
  clientId          String
  client            Client             @relation(fields: [clientId], references: [id])
  
  transactions      Transaction[]      // المعاملات المرتبطة بهذا الصك
  
  aiLogs            AIAnalysisLog[]    // سجل عمليات التحليل لهذا الصك

  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  
  @@index([deedNumber])
  @@index([district])
  @@index([clientId])
}

// ===============================================
// *. نموذج جديد: سجل تحليل الذكاء الاصطناعي
// ===============================================

model AIAnalysisLog {
  id                String         @id @default(cuid())
  
  fileName          String         // اسم الملف المرفوع
  filePath          String         // مسار الملف
  fileSize          Int
  
  status            String         // Success, Failed
  confidenceScore   Float?         // نسبة الدقة (0-100)
  
  extractedData     Json           // البيانات الخام المستخرجة (Raw JSON)
  
  // هل تم اعتماد هذه البيانات وإنشاء صك بها؟
  isApproved        Boolean        @default(false)
  
  // ربط اختياري بالصك الذي تم إنشاؤه
  ownershipId       String?
  ownership         OwnershipFile? @relation(fields: [ownershipId], references: [id])
  
  performedBy       String?        // معرف الموظف الذي قام بالعملية
  createdAt         DateTime       @default(now())
}

// ===============================================
// 4. نموذج المعاملات والمشاريع (Core Business Logic)
// ===============================================

// ------ نموذج المشروع ------
model Project {
  id          Int      @id @default(autoincrement())
  title       String   @unique
  description String?
  status      String   @default("Pending")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  manager     Employee? @relation(fields: [managerId], references: [id])
  managerId   String?

  transactions Transaction[]
}

// ------ نموذج المعاملة (قلب النظام) ------
model Transaction {
  id              String    @id @default(cuid())
  transactionCode String    @unique
  title           String 

  // --- النوع والقالب ---
  transactionType    TransactionType? @relation(fields: [transactionTypeId], references: [id])
  transactionTypeId  String?

  // --- البيانات الأساسية ---
  status       String  @default("Draft")
  statusColor  String? @default("#6b7280")
  priority     String? @default("متوسط")
  description  String?
  location     String?
  deedNumber   String? // يمكن استبداله بالربط مع OwnershipFile
  projectClassification String?

  // --- بيانات التتبع والتقدم ---
  category     String? 
  complexity   String? 
  duration     Int?      
  progress     Float?  @default(0)

  // --- البيانات المالية ---
  totalFees       Float?  @default(0) 
  paidAmount      Float?  @default(0)
  remainingAmount Float?  @default(0)
  fees            Json?    

  // --- التفاصيل الفنية (JSON) ---
  floors               Json? @default("[]")
  setbacks             Json? @default("[]")
  components           Json? @default("[]")
  componentsOldLicense Json? @default("[]")
  componentsProposed   Json? @default("[]")
  componentsExisting   Json? @default("[]")
  boundaries           Json? @default("[]")
  landArea             Json? @default("{}")
  
  authorities          String[] 
  stages               Json?    
  warnings             String[]
  notes                Json? @default("{}")
  approvals            Json? @default("{}")
  requestPurposes      Json?
  
  // --- العلاقات ---
  client       Client    @relation(fields: [clientId], references: [id])
  clientId     String

  // علاقة جديدة مع الملكية (شاشة 310)
  ownership    OwnershipFile? @relation(fields: [ownershipId], references: [id])
  ownershipId  String?

  project      Project? @relation(fields: [projectId], references: [id])
  projectId    Int?

  contract     Contract? @relation(fields: [contractId], references: [id])
  contractId   String?

  // --- المرفقات والمهام والموظفين ---
  attachments          Attachment[]
  payments             Payment[]
  tasks                Task[]
  documents            Document[]
  appointments         Appointment[]
  transactionEmployees TransactionEmployee[]
  followUpTasks        FollowUpTask[]
  
  // --- تواريخ ---
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  completedDate   DateTime?
}

// ------ نوع المعاملة (Configuration) ------
model TransactionType {
  id             String    @id @default(cuid())
  code           String    @unique
  name           String    @unique
  description    String?
  isActive       Boolean   @default(true)

  // تفاصيل الإعدادات
  category       String? 
  categoryAr     String? 
  duration       Int?      @default(0)
  estimatedCost  Float?    @default(0) 
  complexity     String? 

  defaultCosts   Json?
  // القيم الافتراضية
  tasks          Json?    
  documents      String[] 
  authorities    String[] 
  fees           Json?    
  stages         Json?    
  warnings       String[] 
  notes          String[] 

  transactions   Transaction[]
}

// ------ سجل الموظفين العاملين على المعاملة ------
model TransactionEmployee {
  id             String      @id @default(cuid())
  
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId  String
  
  employee       Employee    @relation(fields: [employeeId], references: [id])
  employeeId     String
  
  role           String      // الدور في المعاملة (مهندس مصمم، مراجع، etc)
  
  createdAt      DateTime    @default(now())

  @@unique([transactionId, employeeId])
  @@index([transactionId])
  @@index([employeeId])
}

// ===============================================
// 5. النماذج الديناميكية (Dynamic Forms)
// ===============================================

model RequestPurpose {
  id          String  @id @default(cuid())
  type        String  // 'brief' أو 'detailed'
  name        String
  nameEn      String
  description String?
  icon        String?
  color       String?
  isActive    Boolean @default(true)

  dynamicForm DynamicFormDefinition?

  @@unique([type, name]) 
}

model DynamicFormDefinition {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?

  purpose     RequestPurpose @relation(fields: [purposeId], references: [id], onDelete: Cascade)
  purposeId   String    @unique 

  fields      DynamicFormField[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model DynamicFormField {
  id               String  @id @default(cuid())
  label            String  
  fieldKey         String  
  fieldType        String  
  order            Int     @default(0) 
  
  optionsJson      Json? 
  validationJson   Json? 
  placeholder      String?

  form             DynamicFormDefinition @relation(fields: [formId], references: [id], onDelete: Cascade)
  formId           String

  @@index([formId])
  @@unique([formId, fieldKey]) 
}

// ===============================================
// 6. المهام والمواعيد (Task & Appointment Management)
// ===============================================

model Task {
  id                String     @id @default(cuid())
  taskNumber        String?    @unique
  title             String
  description       String?
  status            String     @default("Pending")
  dueDate           DateTime?
  
  priority          String?    @default("medium")
  progress          Int?       @default(0)
  category          String?
  assignedById      String?    
  receivedDate      DateTime?
  completedDate     DateTime?
  attachmentsCount  Int?       @default(0)
  commentsCount     Int?       @default(0)
  fees              Json?      

  createdAt         DateTime   @default(now())

  transaction       Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId     String

  assignedTo        Employee? @relation("EmployeeToTask", fields: [assignedToId], references: [id])
  assignedToId      String?
  
  @@index([assignedToId]) 
  @@index([transactionId])
}

model Appointment {
  id             String      @id @default(cuid())
  title          String      
  date           DateTime    
  type           String      
  status         String      @default("scheduled") 
  notes          String?     
  location       String?     
  
  transaction    Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId  String

  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  @@index([transactionId])
}

// ===============================================
// 7. المالية والعقود (Finance & Contracts)
// ===============================================

model Contract {
  id             String    @id @default(cuid())
  contractCode   String    @unique
  title          String
  startDate      DateTime
  endDate        DateTime
  totalValue     Float
  status         String    @default("Active")

  client         Client    @relation(fields: [clientId], references: [id])
  clientId       String

  transactions   Transaction[]
  quotation      Quotation? @relation(fields: [quotationId], references: [id])
  quotationId    String?    @unique
  attachments    Attachment[]
}

model Quotation {
  id             String    @id @default(cuid())
  quotationCode  String    @unique
  status         String    @default("Pending")
  totalValue     Float
  createdAt      DateTime  @default(now())

  client         Client     @relation(fields: [clientId], references: [id])
  clientId       String

  contract       Contract?
}

model Payment {
  id              String    @id @default(cuid())
  amount          Float
  date            DateTime  @default(now())
  method          String    // (Cash, Check, Transfer)
  reference       String?
  notes           String?
  
  category        String?   @default("أتعاب مكتب") 
  isFollowUpFee   Boolean   @default(false)        
  receiptImage    String?                          

  receivedBy      Employee  @relation("EmployeeToPayment", fields: [receivedById], references: [id])
  receivedById    String
  
  allocations     Json?     @default("[]")

  transaction     Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId   String

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([transactionId])
  @@index([receivedById])
}

// ===============================================
// 8. إدارة الوثائق والأرشفة (DMS)
// ===============================================

model Document {
  id               String    @id @default(cuid())
  fileNumber       String    @unique
  name             String    
  type             String    // 'file' أو 'folder'
  extension        String?   
  size             Int?      
  filePath         String?   @unique
  
  createdAt        DateTime  @default(now())
  modifiedAt       DateTime  @updatedAt
  
  owner            Employee  @relation("OwnedDocuments", fields: [ownerId], references: [id])
  ownerId          String
  
  classification    DocumentClassification? @relation(fields: [classificationId], references: [id])
  classificationId  String?
  
  tags              String[] 
  version           String    @default("1.0")
  isShared          Boolean   @default(false)
  downloads         Int       @default(0)
  views             Int       @default(0)

  // هيكلية المجلدات
  path              String    
  parent            Document? @relation("FolderHierarchy", fields: [parentId], references: [id], onDelete: Cascade)
  parentId          String?
  children          Document[] @relation("FolderHierarchy")

  // الربط بالكيانات الأخرى
  transaction       Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId     String?
  
  client            Client?       @relation(fields: [clientId], references: [id])
  clientId          String?

  permissions       DocumentPermission[]
  activities        DocumentActivity[]
  
  @@index([ownerId])
  @@index([parentId])
  @@index([transactionId])
  @@index([clientId])
  @@index([classificationId])
}

// ===============================================
// *. إعدادات أنواع المستندات (Document Types Config)
// ===============================================

model DocumentType {
  id                 String   @id @default(cuid())
  code               String   @unique // DOC-001
  name               String
  nameEn             String?
  
  classification     String   // "مالي", "فني", "إداري", "قانوني"
  allowedExtensions  String[] // ["PDF", "JPG", "DWG"]
  maxSizeMB          Int      @default(5)
  
  requiresSignature  Boolean  @default(false)
  confidentiality    String   @default("General") // "General", "Confidential", "TopSecret"
  allowMultiple      Boolean  @default(false) // هل يسمح برفع أكثر من ملف لهذا النوع في المعاملة الواحدة؟
  
  status             String   @default("Active")
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model DocumentPermission {
  id               String    @id @default(cuid())
  permissionNumber String    @unique @default(cuid())
  
  document         Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId       String
  
  user             Employee  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId           String
  
  accessLevel      String    // 'view', 'edit', 'delete', 'admin'
  expiryDate       DateTime?
  
  grantedBy        Employee  @relation("GrantedPermissions", fields: [grantedById], references: [id])
  grantedById      String
  grantedAt        DateTime  @default(now())

  @@unique([documentId, userId])
  @@index([userId])
}

model DocumentActivity {
  id             String    @id @default(cuid())
  activityNumber String    @unique @default(cuid())
  
  document       Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId     String
  
  fileName       String    
  action         String    // 'upload', 'download', 'edit', 'delete', ...
  
  user           Employee  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String
  
  timestamp      DateTime  @default(now())
  ipAddress      String?
  details        String?

  @@index([documentId])
  @@index([userId])
}

model DocumentClassification {
  id          String    @id @default(cuid())
  name        String    @unique
  color       String    @default("#6b7280")
  description String?

  createdBy    Employee  @relation("CreatedClassifications", fields: [createdById], references: [id])
  createdById  String
  createdAt    DateTime  @default(now())

  documents    Document[]

  @@index([createdById])
}

model Attachment {
  id             String    @id @default(cuid())
  fileName       String
  filePath       String    @unique
  fileType       String
  fileSize       Int
  createdAt      DateTime  @default(now())

  uploadedBy     Employee  @relation(fields: [uploadedById], references: [id])
  uploadedById   String

  transaction    Transaction? @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId  String?

  contract       Contract?    @relation(fields: [contractId], references: [id])
  contractId     String?

  client         Client?      @relation(fields: [clientId], references: [id])
  clientId       String?

  employee       Employee?    @relation("EmployeeAttachments", fields: [employeeId], references: [id], onDelete: Cascade)
  employeeId     String?
}

// ===============================================
// 9. وحدات إضافية (التعقيب، شوارع الرياض، الإعدادات)
// ===============================================

// وحدة التعقيب (Follow-Up)
model FollowUpAgent {
  id                 String    @id @default(cuid())
  type               String    // 'individual' or 'entity'
  name               String
  nationalId         String?  
  commercialRegister String?  
  
  phone              String
  email              String?
  address            String?

  specialization     String[] 
  governmentEntities String[] 

  joinDate           DateTime @default(now())
  status             String   @default("active") 
  rating             Float    @default(5.0)
  notes              String?

  tasks              FollowUpTask[]

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

model FollowUpTask {
  id                 String    @id @default(cuid())
  
  agent              FollowUpAgent @relation(fields: [agentId], references: [id], onDelete: Cascade)
  agentId            String

  transaction        Transaction   @relation(fields: [transactionId], references: [id], onDelete: Cascade)
  transactionId      String

  governmentEntity   String   
  description        String   
  
  startDate          DateTime @default(now())
  targetDate         DateTime?
  completionDate     DateTime?

  status             String   @default("pending") 
  successStatus      String   @default("pending") 
  attempts           Int      @default(0)          
  
  notes              String?
  feedbacks          String[] 

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([agentId])
  @@index([transactionId])
}

// وحدة شوارع الرياض
model RiyadhSector {
  id        String         @id @default(cuid())
  name      String         @unique 
  streets   RiyadhStreet[]
  createdAt DateTime       @default(now())
}

model RiyadhDistrict {
  id        String         @id @default(cuid())
  name      String         @unique 
  streets   RiyadhStreet[]
  createdAt DateTime       @default(now())
}

model RiyadhStreet {
  id               String    @id @default(cuid())
  streetCode       String    @unique 
  name             String

  sector           RiyadhSector   @relation(fields: [sectorId], references: [id])
  sectorId         String
  
  district         RiyadhDistrict @relation(fields: [districtId], references: [id])
  districtId       String

  type             String    
  width            Float
  length           Float
  lanes            Int
  status           String    
  
  lighting         Boolean  @default(true)
  sidewalks        Boolean  @default(true)

  centerLat        Float
  centerLng        Float

  hasSpecialRegulation Boolean @default(false)
  regulationDetails    Json?    
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@index([sectorId])
  @@index([districtId])
}

// سجل الأنشطة العام
model ActivityLog {
  id             String    @id @default(cuid())
  date           DateTime  @default(now())
  action         String 
  description    String
  category       String 

  performedBy    Employee @relation("EmployeeToActivityLog", fields: [performedById], references: [id])
  performedById  String

  client         Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientId       String

  @@index([clientId])
  @@index([performedById])
}

// إعدادات النظام
model SystemSettings {
  id               String    @id @default("singleton") 
  gradingCriteria  Json? 
  gradeThresholds  Json? 

  updatedAt        DateTime @updatedAt
}

// نظام المحادثات
model Conversation {
  id            String    @id @default(cuid())
  name          String?
  createdAt     DateTime  @default(now())

  participants  Employee[] @relation("EmployeeToConversation")
  messages      Message[]
}

model Message {
  id              String    @id @default(cuid())
  content         String
  createdAt       DateTime  @default(now())

  conversation    Conversation @relation(fields: [conversationId], references: [id])
  conversationId  String

  sender          Employee     @relation("SenderToMessage", fields: [senderId], references: [id])
  senderId        String
}

