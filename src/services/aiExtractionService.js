const { fromBuffer } = require("pdf2pic");
const { PDFDocument } = require("pdf-lib");
const { OpenAI } = require("openai");
const pLimit = require("p-limit"); // ููุชุญูู ูู ุนุฏุฏ ุงูุทูุจุงุช ุงููุชุฒุงููุฉ

const openai = new OpenAI({ apiKey: process.env.OPENAI_API_KEY });

// ุชุญุฏูุฏ ุนุฏุฏ ุงูุทูุจุงุช ุงููุชุฒุงููุฉ (3 ุทูุจุงุช ูู ููุณ ุงูููุช ููุญูุงุธ ุนูู ุงูุงุณุชูุฑุงุฑ)
const limit = pLimit(3);

exports.extractPropertyData = async (fileBuffer, mimeType) => {
  try {
    if (mimeType !== "application/pdf") {
      throw new Error("ูุฌุจ ุฑูุน ููู PDF ูุญุชูู ุนูู ุงูุตููู");
    }

    // 1. ุชุญููู ููู PDF
    const pdfDoc = await PDFDocument.load(fileBuffer);
    const totalPages = pdfDoc.getPageCount();
    console.log(
      `๐ ุชู ุฑุตุฏ ${totalPages} ุตูุญุงุช. ุจุฏุก ูุถุน ุงูุฏูุฉ ุงูุนุงููุฉ (High-Fidelity)...`,
    );

    // ุฅุนุฏุงุฏุงุช "ุฌูุฏุฉ ุงูุทุจุงุนุฉ" ููุฑุงุกุฉ ุฃุฏู ุงูุชูุงุตูู
    const options = {
      density: 300, // ุฑูุนูุง ุงูุฏูุฉ ูู 150 ุฅูู 300 (ุถุฑูุฑู ููุฃุฑูุงู)
      format: "png",
      width: 2480, // ุนุฑุถ ูุฑูุฉ A4 ูุงููุฉ
      height: 3508,
    };

    const convert = fromBuffer(fileBuffer, options);

    // 2. ุชุฌููุฒ ุงูุทูุจุงุช (ูุน ูุถุน ุญุฏ ููุชุฒุงูู ูุชุฌูุจ Timeout)
    const extractionPromises = Array.from({ length: totalPages }, (_, i) => {
      return limit(async () => {
        const pageNum = i + 1;
        try {
          console.log(`๐ธ ุฌุงุฑู ุงููุณุญ ุงูุถูุฆู ููุตูุญุฉ ${pageNum} ุจุฏูุฉ ุนุงููุฉ...`);

          // ุชุญููู ุงูุตูุญุฉ
          const image = await convert(pageNum, { responseType: "base64" });

          // 3. ุงูุจุฑููุจุช ุงูุฐูู (OCR + Extraction)
          const response = await openai.chat.completions.create({
            model: "gpt-4o",
            messages: [
              {
                role: "system",
                content: `ุฃูุช ุฎุจูุฑ ููุนุชูุฏ ูู ุชุญููู ุงูุตููู ุงูุนูุงุฑูุฉ ุงูุณุนูุฏูุฉุ ุชุนูู ุชุญุช ุฅุดุฑุงู ูุฒุงุฑุฉ ุงูุนุฏู. ูููุชู ุงููุญูุฏุฉ ูู ุงุณุชุฎุฑุงุฌ ุงูุจูุงูุงุช ุงูุฑุณููุฉ ูู ุงูุตู ูููุณ ูู ุฃู ูุณุชูุฏุงุช ููุญูุฉ (ูุซู ุงูุณุฌู ุงูุชุฌุงุฑู ุฃู ุนููุฏ ุงูุจูุน).

                ุชุฐููุฑ ุฏุงุฆููุง:
                - ุฑูู ุงูุตู ุงูุญูููู ูุธูุฑ **ููุท** ูู ุงูููุฏุฑ (ุฃุนูู ุงูุตูุญุฉ) ุฃู ุงูููุชุฑ (ุฃุณูู ุงูุตูุญุฉ)ุ ุบุงูุจูุง ุจุฌุงูุจ ุนุจุงุฑุฉ "ุตู" ุฃู "ุฑูู ุงูุตู".
                - ูุง ุชุฃุฎุฐ ุฃู ุฑูู ูู ูุณุท ุงูุตูุญุฉ (ูุซู ุจูุงูุงุช ุงููุงูู ุฃู ุงูุณุฌู ุงูุชุฌุงุฑู).
                - ุงูุณุฌู ุงูุชุฌุงุฑู (Commercial Registration / CR No) ููุณ ุตููุงุ ููุฌุจ ุชุฌุงููู ุชูุงููุง.
                - ุงูุชุงุฑูุฎ ุงููุฑุชุจุท ุจุฑูู ุงูุตู ูููู ูุฌุฑููุง (ูุซุงู: 1443/09/12)ุ ูุบุงูุจูุง ูู ููุณ ุณุทุฑ ุฃู ููุทูุฉ ุฑูู ุงูุตู.
                - ุงููุณุงุญุฉ ุชูุณุชุฎุฑุฌ ููุท ุฅุฐุง ูุงูุช ูุฑุชุจุทุฉ ุจุนุจุงุฑุฉ "ูุณุงุญุฉ" ุฃู "ุฅุฌูุงูู ุงููุณุงุญุฉ" ุฃู "Total Area"ุ ูููุณุช ุฑูู ุงููุทุนุฉ ุฃู ุงููุฎุทุท.
                - ุงุณู ุงููุงูู ูุฌุจ ุฃู ูุคุฎุฐ ูู ูุณู "ุงููุงูู" ุฃู "ุงููุณุชููุฏ" ูู ูุต ุงูุตูุ ูููุณ ูู ุงูููุฏุฑ ุฃู ุงูููุชุฑ.`,
              },
              {
                role: "user",
                content: [
                  {
                    type: "text",
                    text: `ุญููู ุงูุตูุฑุฉ ุงูุชุงููุฉ ุจุฏูุฉ ุนุงููุฉ. ุงุณุชุฎุฑุฌ ุงูุจูุงูุงุช ุงูุชุงููุฉ ูู ุชูุณูู JSON ุญุตุฑููุง:

                  {
                    "documentNo": "ุฑูู ุงูุตู (10โ14 ุฑูููุง) ุงูููุฌูุฏ ูู ุงูููุฏุฑ ุฃู ุงูููุชุฑ ููุท. ุฅุฐุง ูู ููุฌุฏ ููุงูุ ูุงุฌุนูู null.",
                    "documentDate": "ุงูุชุงุฑูุฎ ุงููุฌุฑู (YYYY/M/D) ุงููุฑุชุจุท ูุจุงุดุฑุฉู ุจุฑูู ุงูุตู ูู ุงูููุฏุฑ/ุงูููุชุฑ. null ุฅุฐุง ุบูุฑ ููุฌูุฏ ุฃู ูุดุจูู.",
                    "areaSqm": "ุงููุณุงุญุฉ ุงูุฑูููุฉ (ูุซู 350.75) ุงููุฑุชุจุทุฉ ุจู 'ูุณุงุญุฉ' ุฃู 'Total Area'. null ุฅุฐุง ุบูุฑ ูุงุถุญุฉ.",
                    "ownerName": "ุงุณู ุงููุงูู ุงููุงูู ููุง ูุฑุฏ ูู ูุต ุงูุตู (ููุณ ูู ุงูููุฏุฑ).",
                    "verificationText": "ุงูุชุจุณ ุงููุต ุงูุญุฑูู (20โ50 ุญุฑููุง) ุงูุฐู ูุญุชูู ุนูู ุฑูู ุงูุตู ูุชุคูุฏ ุฃูู ูู ุงูููุฏุฑ/ุงูููุชุฑ."
                  }

                  โ๏ธ ููุงุนุฏ ุตุงุฑูุฉ:
                  - ุฅุฐุง ุธูุฑ ุฑูู ูู ูุณุท ุงูุตูุญุฉ (ูุซู ุงูุณุฌู ุงูุชุฌุงุฑู)ุ ุชุฌุงููู ุญุชู ูู ูุงู ุทููููุง.
                  - ูุง ุชุฎูู. ุฅุฐุง ูู ุชูู ูุชุฃูุฏูุง ุจูุณุจุฉ 95%ุ ุงุฌุนู ุงูุญูู null.
                  - ูุง ุชุฎูุท ุจูู "ุฑูู ุงูุตู" ู"ุฑูู ุงูุฅุญุงูุฉ" ุฃู "ุงูุณุฌู ุงูุชุฌุงุฑู" ุฃู "ุฑูู ุงูุนูุฏ".`,
                  },
                  {
                    type: "image_url",
                    image_url: {
                      url: `data:image/png;base64,${image.base64}`,
                      detail: "high",
                    },
                  },
                ],
              },
            ],
            response_format: { type: "json_object" },
            temperature: 0.0, // ุฃุฎูุถูุง ุฅูู 0.0 ูุถูุงู ุฃูู ูุฏุฑ ูู ุงูุชุฎููู
          });

          const content = JSON.parse(response.choices[0].message.content);

          console.log(
            `โ ุตูุญุฉ ${pageNum}: ุชู ุงุณุชุฎุฑุงุฌ ุงูุตู ุฑูู ${content.documentNo}`,
          );

          return {
            page: pageNum,
            documentNo: content.documentNo,
            documentDate: content.documentDate,
            areaSqm: content.areaSqm,
            ownerName: content.ownerName,
            verificationText: content.extractedTextSnippet, // ุญูู ุฅุถุงูู ูุชุชุฃูุฏ ููู ูุฑุฃ ุงูุฑูู
            success: true,
          };
        } catch (err) {
          console.error(`โ ูุดู ูู ุงูุตูุญุฉ ${pageNum}:`, err.message);
          return { page: pageNum, success: false, error: "ูุดู ุชุญููู ุงูุตูุฑุฉ" };
        }
      });
    });

    const results = await Promise.all(extractionPromises);

    return {
      success: true,
      totalPages,
      documents: results,
    };
  } catch (error) {
    console.error("Critical AI Error:", error);
    return { success: false, error: "ุญุฏุซ ุฎุทุฃ ุฌุณูู ูู ุงููุนุงูุฌุฉ" };
  }
};
